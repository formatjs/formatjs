name: Rust CLI Release

on:
  push:
    tags:
      - 'formatjs_cli_v*'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (build only, no release)'
        type: boolean
        required: false
        default: true

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build:
    name: Build ${{ matrix.platform }}
    runs-on: ${{ matrix.runner }}

    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: macOS ARM64
            runner: macos-latest
            bazel_platform: //rust/formatjs_cli/platforms:darwin_arm64
            artifact_name: formatjs_cli-darwin-arm64
            config: ci-darwin
          - platform: Linux x86_64
            runner: ubuntu-latest
            bazel_platform: //rust/formatjs_cli/platforms:linux_x86_64
            artifact_name: formatjs_cli-linux-x64
            config: ci

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6

      - name: Setup Bazel
        uses: bazel-contrib/setup-bazel@0.16.0
        with:
          bazelisk-cache: true
          disk-cache: ${{ github.workflow }}-${{ matrix.platform }}
          repository-cache: true

      - name: Build Binary
        run: |
          if [ -n "${{ secrets.BUILDBUDDY_ORG_API_KEY }}" ]; then
            bazel build \
              --config=${{ matrix.config }} \
              --compilation_mode=opt \
              --platforms=${{ matrix.bazel_platform }} \
              --remote_download_outputs=all \
              --remote_header=x-buildbuddy-api-key=${{ secrets.BUILDBUDDY_ORG_API_KEY }} \
              //rust/formatjs_cli:release_binary
          else
            bazel build \
              --compilation_mode=opt \
              --platforms=${{ matrix.bazel_platform }} \
              //rust/formatjs_cli:release_binary
          fi

          # Copy binary to artifacts directory
          mkdir -p artifacts
          cp bazel-bin/rust/formatjs_cli/formatjs_cli_release artifacts/${{ matrix.artifact_name }}
          chmod +x artifacts/${{ matrix.artifact_name }}

      - name: Smoke Test
        run: |
          ./artifacts/${{ matrix.artifact_name }} --version
          ./artifacts/${{ matrix.artifact_name }} --help

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: artifacts/${{ matrix.artifact_name }}
          retention-days: 7

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    if: ${{ !inputs.dry_run }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6

      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: release/

      - name: Organize Artifacts
        run: |
          # List downloaded artifacts structure for debugging
          ls -R release/

          # Move binaries from subdirectories to release root
          mv release/formatjs_cli-darwin-arm64/formatjs_cli-darwin-arm64 release/formatjs_cli-darwin-arm64.bin
          mv release/formatjs_cli-linux-x64/formatjs_cli-linux-x64 release/formatjs_cli-linux-x64.bin

          # Remove empty directories
          rmdir release/formatjs_cli-darwin-arm64 release/formatjs_cli-linux-x64

          # Rename binaries to final names
          mv release/formatjs_cli-darwin-arm64.bin release/formatjs_cli-darwin-arm64
          mv release/formatjs_cli-linux-x64.bin release/formatjs_cli-linux-x64

      - name: Generate Checksums
        run: |
          cd release
          shasum -a 256 formatjs_cli-* > checksums.txt
          cat checksums.txt

      - name: List Release Artifacts
        run: |
          ls -lh release/
          echo "---"
          echo "Checksums:"
          cat release/checksums.txt

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/formatjs_cli_v')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            release/formatjs_cli-darwin-arm64
            release/formatjs_cli-linux-x64
            release/checksums.txt
          body: |
            ## FormatJS Rust CLI Release

            ### Binaries
            - **macOS Apple Silicon**: `formatjs_cli-darwin-arm64`
            - **Linux x86_64**: `formatjs_cli-linux-x64`

            ### Installation

            ```bash
            # macOS (Apple Silicon)
            curl -LO https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/formatjs_cli-darwin-arm64
            chmod +x formatjs_cli-darwin-arm64
            sudo mv formatjs_cli-darwin-arm64 /usr/local/bin/formatjs

            # Linux
            curl -LO https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/formatjs_cli-linux-x64
            chmod +x formatjs_cli-linux-x64
            sudo mv formatjs_cli-linux-x64 /usr/local/bin/formatjs
            ```

            ### Verification

            Verify the checksums:
            ```bash
            curl -LO https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/checksums.txt
            shasum -a 256 -c checksums.txt
            ```
          draft: false
          prerelease: false
