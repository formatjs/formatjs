load("@aspect_bazel_lib//lib:copy_file.bzl", "copy_file")
load("@npm//:defs.bzl", "npm_link_all_packages")
load("//tools:vitest.bzl", "vitest")

npm_link_all_packages()

# Copy Rust CLI binary to integration tests directory so js_run_binary can find it
copy_file(
    name = "rust_cli_copy",
    src = "//crates/formatjs_cli",
    out = "formatjs_cli",
    visibility = ["//visibility:private"],
)

GLIMMER_HBS_DEPS = [
    "//:node_modules/@glimmer/syntax",
    "//:node_modules/content-tag",
]

# Export fixtures for use by Rust CLI integration tests
filegroup(
    name = "compile_fixtures",
    srcs = glob(["compile/**/*"]),
    visibility = ["//visibility:public"],
)

filegroup(
    name = "extract_fixtures",
    srcs = glob(
        ["extract/**/*"],
        exclude = [
            "extract/**/*.test.ts",
            "extract/__snapshots__/*",
        ],
    ),
    visibility = ["//visibility:public"],
)

filegroup(
    name = "verify_fixtures",
    srcs = glob(
        ["verify/**/*"],
        exclude = [
            "verify/*.test.ts",
            "verify/__snapshots__/*",
        ],
    ),
    visibility = ["//visibility:public"],
)

vitest(
    name = "compile_folder_integration_test",
    srcs = glob(
        ["compile_folder/*.test.ts"],
    ),
    fixtures = glob(
        ["compile_folder/**/*"],
        exclude = ["compile_folder/*.test.ts"],
    ),
    deps = [
        ":node_modules/@formatjs/cli",
        "//:node_modules/@types/fs-extra",
        "//:node_modules/fast-glob",
        "//:node_modules/fs-extra",
    ],
)

# Disabled: Replaced by conformance_test which covers all scenarios
# and directly compares Rust vs TypeScript CLI outputs
# vitest(
#     name = "extract_integration_test",
#     srcs = glob(
#         ["extract/**/*.test.ts"],
#     ) + [
#         "formatter.js",
#         "rust-binary-utils.ts",
#         ":node_modules/@formatjs/cli",
#         ":rust_cli_copy",
#         "//:node_modules/@types/fs-extra",
#         "//:node_modules/fast-glob",
#         "//:node_modules/fs-extra",
#     ],
#     data = [
#         "//crates/formatjs_cli",
#     ],
#     fixtures = glob(
#         ["extract/**/*"],
#         exclude = [
#             "extract/**/*.test.ts",
#             "extract/__snapshots__/*",
#         ],
#     ),
#     snapshots = glob(
#         ["extract/__snapshots__/*"],
#     ),
#     deps = ["//:node_modules/@bazel/runfiles"],
# )

vitest(
    name = "extract_vue_integration_test",
    srcs = glob(
        ["extract-vue/*.test.ts"],
    ),
    fixtures = glob(
        ["extract-vue/**/*"],
        exclude = ["extract-vue/*.test.ts"],
    ),
    deps = [
        ":node_modules/@formatjs/cli",
        "//:node_modules/@babel/types",
        "//:node_modules/@vue/compiler-core",
        "//:node_modules/fast-glob",
        "//:node_modules/vue",
    ],
)

vitest(
    name = "extract_glimmer_integration_test",
    srcs = glob(
        ["extract-glimmer/*.test.ts"],
    ),
    fixtures = glob(
        ["extract-glimmer/**/*"],
        exclude = ["extract-glimmer/*.test.ts"],
    ),
    deps = [
        ":node_modules/@formatjs/cli",
        "//:node_modules/@babel/types",
        "//:node_modules/fast-glob",
    ] + GLIMMER_HBS_DEPS,
)

vitest(
    name = "compile_integration_test",
    srcs = [
        "formatter.js",
        "rust-binary-utils.ts",
        ":node_modules/@formatjs/cli",
        ":rust_cli_copy",
    ] + glob(
        ["compile/**/*"],
    ),
    data = [
        "//crates/formatjs_cli",
    ],
    deps = ["//:node_modules/@bazel/runfiles"],
)

vitest(
    name = "verify_integration_test",
    srcs = [
        "rust-binary-utils.ts",
        ":rust_cli_copy",
    ] + glob(
        ["verify/*.test.ts"],
    ),
    data = [
        "//crates/formatjs_cli",
    ],
    fixtures = glob(
        ["verify/**/*"],
        exclude = [
            "verify/*.test.ts",
            "verify/__snapshots__/*",
        ],
    ),
    deps = [
        ":node_modules/@formatjs/cli",
        "//:node_modules/@bazel/runfiles",
    ],
)

vitest(
    name = "conformance_test",
    srcs = [
        "rust-binary-utils.ts",
        ":node_modules/@formatjs/cli",
        ":rust_cli_copy",
    ] + glob(
        ["conformance-tests/*.test.ts"],
    ),
    data = [
        "//crates/formatjs_cli",
    ],
    fixtures = glob(
        ["conformance-tests/test_cases/*.txt"],
    ),
    deps = [
        "//:node_modules/@bazel/runfiles",
        "//:node_modules/@types/fs-extra",
        "//:node_modules/fs-extra",
    ],
)
